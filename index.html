<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Nanotwitter by Dewar0019</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Nanotwitter</h1>
        <h2>Nano Version of Twitter</h2>
        <a href="https://github.com/Dewar0019/nanotwitter" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <p>Shraddha Basnyat, Viet Le, Subahu Rayamajhi, Dewar Tan</p>

<h1>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>This is a nano version of <a href="https://twitter.com/">Twitter</a> that we built for <a href="http://bit.ly/cosi105b-2015">COSI 105B: Software Development for Scability</a> instructed by Pito Salas at Brandeis University.</p>

<p>The main purpose of this project is to apply scaling techniques that we learned in class to a live project under controlled environments.</p>

<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h1>

<p>Following the project guidelines, our NanoTwitter has implemented these functionalities:</p>

<ul>
<li>
<p>Users:</p>

<ul>
<li>can register for an account by supplying an email, an username, a full name and a password</li>
<li>search for tweets</li>
</ul>
</li>
<li>
<p>Logged in users</p>

<ul>
<li>Can follow and unfollow other registered users</li>
<li>Can tweet</li>
<li>Can see the flow of the last n tweets by the users that they have followed</li>
<li>Can favorite and retweet any tweet</li>
</ul>
</li>
<li>
<p>Non-logged in users</p>

<ul>
<li>See the flow of the last n tweets by any user</li>
</ul>
</li>
<li>
<p>Tweets</p>

<ul>
<li>Consist of

<ul>
<li>a 140 characters of text (HTML escape)</li>
<li>a date-time of creation</li>
</ul>
</li>
<li>Belong to one user</li>
</ul>
</li>
</ul>

<p>We also provide REST API:</p>

<ul>
<li>All start with /api/v1</li>
<li>
<p>Tweets:</p>

<ul>
<li>/tweets/id</li>
<li>/tweets/recent</li>
</ul>
</li>
<li>
<p>Users:</p>

<ul>
<li>/users/id/tweets</li>
<li>/users/id/followers</li>
<li>/users/id/following</li>
<li>/users/id/retweets</li>
<li>/users/id/favorites</li>
</ul>
</li>
</ul>

<p>The below screenshots represent our latest version of the application.</p>

<ol>
<li>Homepage:</li>
</ol>

<p><img src="https://i.imgur.com/zGNLAby.png" alt="homepage"></p>

<ol>
<li>Signup page:</li>
</ol>

<p><img src="https://i.imgur.com/THcqfOq.png" alt="signup"></p>

<ol>
<li>User page</li>
</ol>

<p><img src="https://i.imgur.com/k7RjRqh.png" alt="user"></p>

<ol>
<li>Search results:</li>
</ol>

<p><img src="https://i.imgur.com/Ov5vhoh.png" alt="search"></p>

<h1>
<a id="load-testing" class="anchor" href="#load-testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Load testing</h1>

<p>We used <a href="http://loader.io/">loader.io</a> to benchmark our app, connecting 500 users over the course of 1 minute.</p>

<p>We did 3 main load tests:</p>

<ol>
<li><p>GET / - load up homepage</p></li>
<li><p>GET /user/testuser - load up testuser homepage</p></li>
<li><p>POST /user/testuser/tweet - have testuser create 1 tweet</p></li>
</ol>

<p>Our final results are as followings:</p>

<ol>
<li>Load Homepage, 2000 visits</li>



<a href="http://ldr.io/1SN5bwY">Conditions: users=100 tweets=500 followers=30</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/d5c2be89a464c0f276406724b56e8505'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/d5c2be89a464c0f276406724b56e8505" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>

<a href="http://ldr.io/1TZOIXf">Conditions: users=500 tweets=500 followers=100</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/a36f5a8bfc085da16f28a6b06512c9b9'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/a36f5a8bfc085da16f28a6b06512c9b9" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>

<a href="http://ldr.io/1Nah4LS">Conditions: users=3000 tweets=2000 followers=1000</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/bf6e6454d79d8d95444ad9efeca33bff'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/bf6e6454d79d8d95444ad9efeca33bff" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>



<li>Load Test User, 1800 visits</li>

<a href="http://ldr.io/1NUaBIy">Conditions: users=100 tweets=500 followers=30</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/54114fd8a3fa9216caffaead176a5502'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/54114fd8a3fa9216caffaead176a5502" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>


<a href="http://ldr.io/1TZQ4RN">Conditions: users=500 tweets=500 followers=100</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/663dade82910cf81512c56ef4bcb7d26'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/663dade82910cf81512c56ef4bcb7d26" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>

<a href="http://ldr.io/1XU7e93">Conditions: users=3000 tweets=2000 followers=1000</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/ec8b10fecbee10a3074efb0f36718847/widget/results/3dc9a9f8f62cb8d47e7b7bd5e87d92bd'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/ec8b10fecbee10a3074efb0f36718847/results/3dc9a9f8f62cb8d47e7b7bd5e87d92bd" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>


<li>Testuser creates 3000 tweets</li>

<a href="http://ldr.io/1RCSwhI">Conditions: users=100 tweets=500 followers=30</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/cb27819a66470efb424f5a6e4ac56934/widget/results/fe40c7185f054aca937ccb10b37bd6ad'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/cb27819a66470efb424f5a6e4ac56934/results/fe40c7185f054aca937ccb10b37bd6ad" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>


<a href="http://ldr.io/1RCNFx2">Conditions: users=500 tweets=500 followers=100</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/cb27819a66470efb424f5a6e4ac56934/widget/results/230028f31d5038bed694d24393e06fbe'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/cb27819a66470efb424f5a6e4ac56934/results/230028f31d5038bed694d24393e06fbe" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>

<a href="http://ldr.io/1NahrpI">Conditions: users=3000 tweets=2000 followers=1000</a>
<div style="width: 600px;">
<iframe width='600' height='300' frameborder='0' src='//share.loader.io/reports/cb27819a66470efb424f5a6e4ac56934/widget/results/6895eabca8d767df0796cb806a3bc2ae'></iframe>
<div style="width: 100%; text-align: right;">
<a href="http://loader.io/reports/cb27819a66470efb424f5a6e4ac56934/results/6895eabca8d767df0796cb806a3bc2ae" target="_blank" style="padding: 0 10px 10px 0; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px;"></a>
</div></div>

</ol>

<h1>
<a id="technology" class="anchor" href="#technology" aria-hidden="true"><span class="octicon octicon-link"></span></a>Technology</h1>

<h2>
<a id="framework" class="anchor" href="#framework" aria-hidden="true"><span class="octicon octicon-link"></span></a>Framework</h2>

<p>The app was build on top of <a href="http://www.sinatrarb.com/">Sinatra</a>, a Ruby web framework, in <a href="http://www.sinatrarb.com/intro.html#Sinatra::Base%20-%20Middleware,%20Libraries,%20and%20Modular%20Apps">modular style</a>.
A major advantage of writing this app in modular style is that each controller exists as an isolated Sinatra application.</p>

<p>We then use Rack Middleware to mount them to handle the corresponding URL requests.</p>

<h2>
<a id="web-server" class="anchor" href="#web-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Web Server</h2>

<p>We migrated from Ruby default web server, WEBrick to <a href="http://puma.io/">Puma</a> to take advantage of multi threads. In our testing, we couldn't find any noticeable difference between the two.</p>

<h2>
<a id="database" class="anchor" href="#database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database</h2>

<p>We used <a href="http://www.postgresql.org/">PostgreSQL</a> for storing persistent data.</p>

<h2>
<a id="caching" class="anchor" href="#caching" aria-hidden="true"><span class="octicon octicon-link"></span></a>Caching</h2>

<p>We used <a href="http://redis.io/">Redis</a> as caching backend.
On Heroku, we had 3 Redis stores; one for database query caching, one for <a href="http://guides.rubyonrails.org/caching_with_rails.html#fragment-caching">fragment caching</a> and the last one for <a href="http://sidekiq.org/">sidekiq</a>.</p>

<p>The major improvement in response time came from fragment caching.
We put the HTML for a Tweet object in Redis store so each time this object was called, we got the HTML from Redis.
This removed the overhead of connecting to database to get the Tweet object.</p>

<p>In one of our load testing, connecting 100 clients to the homepage over the course of 1 minute, the average response time before fragment caching was implemented was 146ms.
After the fragment caching was introduced, the average time was reduced to 98ms.</p>

<p>We also experimented with page caching, storing the entire page in Redis. This was implemented using <a href="http://rtomayko.github.io/rack-cache/">Rack Cache</a>. Our homepage had 2 additional HTTP headers, Etag and Last-Modified, to be used by Rack Cache to know if the page was updated or not. If there was no change, our old HTML page was served directly from Redis. Otherwise, a new page was rendered and stored in Redis for future usage.</p>

<p>Our homepage benefited a lot from full page caching. However, one bug we encountered was that a logged in user was served the cached version of homepage for non logged in users (without ability to post new tweet and logout). We hadn't been able to fix this bug so full page caching hadn't been implemented in other pages.</p>


<h2>
<a id="background-jobs" class="anchor" href="#background-jobs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background jobs</h2>

<p>We used a lot of callbacks on our application to fill the Timeline table. Every time an user followed another, the former timeline table would be updated with most 50 recent tweets by the latter. Every time the latter tweeted, all of their followers would get the new tweet on their timeline. The major drawback of this implementation was that there were a lot of database writings. Similar to scaling Twitter slides, our application had the cost of  O(1) read and O(n) write.</p>

<p>Background jobs were implemented to reduce the costs of writing. The replication of tweets to all followers were done in the background without affecting the end-users. We used Sidekiq gem to achieve this.</p>

<p>We made an assumption that only a small percentage of users were active content creators, and the rest were content consumers. So the cost of writing was reasonably acceptable to us. However, due to this implementation, it took a long time to setup test cases for load testing. We found that, it was faster to drop and create new database than calling /test/reset/all which tried to destroy every users, tweets, follows and timelines.</p>

<h1>
<a id="miscellaneous" class="anchor" href="#miscellaneous" aria-hidden="true"><span class="octicon octicon-link"></span></a>Miscellaneous</h1>

<h2>
<a id="cdn" class="anchor" href="#cdn" aria-hidden="true"><span class="octicon octicon-link"></span></a>CDN</h2>

<p>Instead of serving static assets from Heroku, we took advantage of public Content delivery networks (CDN) to serve <a href="https://jquery.com/">jQuery</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.</p>

<h2>
<a id="compression" class="anchor" href="#compression" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compression</h2>

<p>We used Rack::Deflater, a Rack middleware which intercepted responses, compressing them before sending them back to users.
Smaller files resulted in faster response time for end users.</p>

<h2>
<a id="what-could-be-done-better" class="anchor" href="#what-could-be-done-better" aria-hidden="true"><span class="octicon octicon-link"></span></a>What could be done better</h2>

<p>We used <a href="http://www.postgresql.org/">PostgreSQL</a> on <a href="http://smalltwitter.herokuapp.com/">Heroku</a> and <a href="https://www.sqlite.org/">SQlite</a> locally because the latter was easy to setup on our local machines.
SQLite lacked a lot of bells and whistles which the former had.
Because production and development environments were different, we didn't invest enough time on improving PostgreSQL</p>

<p>One way of improving database performance was to replace ActiveRecord callbacks with <a href="http://www.postgresql.org/docs/current/static/plpgsql-trigger.html">PostgreSQL triggers</a>.
In our app, we used callbacks to replicate tweets from one user to all their followers.
Each callback connected to the database and ran queries.
Implementing this on PostgreSQL can be faster as we eliminate the need to connect to database.
Additionally, queries running internally would be faster.</p>

<p><a href="http://sidekiq.org/">Sidekiq</a> jobs run asynchronously, and non-sequentially.
There are libraries to make background jobs run sequentially.
Using these, we can have a single URL for creating a test case (reset testuser, seed tweets, seed users, seed followings...), instead of creating 1 job, checking status page to make sure that it is done before running another.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/Dewar0019/nanotwitter/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/Dewar0019/nanotwitter/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/Dewar0019/nanotwitter"></a> is maintained by <a href="https://github.com/Dewar0019">Dewar0019</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>


  </body>
</html>
